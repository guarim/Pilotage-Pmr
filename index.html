<script type="module">
  import {FaceMesh} from "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/face_mesh.js";
  import {drawConnectors, drawLandmarks} from "https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.4/drawing_utils.js";

  const video = document.createElement("video");
  video.setAttribute("autoplay", "");
  video.setAttribute("playsinline", "");
  video.style.display = "none";
  document.body.appendChild(video);

  const canvas = document.getElementById("videoCanvas");
  const ctx = canvas.getContext("2d");

  // ---- Startup webcam ----
  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 1280, height: 720 }
      });
      video.srcObject = stream;
      await video.play();
      console.log("ðŸŽ¥ Webcam OK");
      requestAnimationFrame(processFrame);
    } catch (err) {
      console.error("Erreur webcam :", err);
    }
  }

  // ---- Mediapipe setup ----
  const faceMesh = new FaceMesh({
    locateFile: file =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${file}`
  });

  faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  faceMesh.onResults(onResults);

  // ---- Draw loop ----
  async function processFrame() {
    if (video.videoWidth > 0) {
      await faceMesh.send({ image: video });
    }
    requestAnimationFrame(processFrame);
  }

  // ---- Process landmarks ----
  function onResults(results) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

    if (!results.multiFaceLandmarks) return;

    const lm = results.multiFaceLandmarks[0];

    // Exemple : afficher seulement iris et yeux
    drawLandmarks(ctx, lm.slice(468, 478), { color: "#00FFFF", radius: 3 }); // IRIS
    drawLandmarks(ctx, [lm[159], lm[145], lm[386], lm[374]], {
      color: "magenta",
      radius: 3
    });
  }

  // ---- Start ----
  startCamera();
</script>

